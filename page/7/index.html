<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="童真的烂漫" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="代码简单点，bug少一点！">
<meta property="og:type" content="website">
<meta property="og:title" content="童真的烂漫">
<meta property="og:url" content="http://yoursite.com/page/7/index.html">
<meta property="og:site_name" content="童真的烂漫">
<meta property="og:description" content="代码简单点，bug少一点！">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="童真的烂漫">
<meta name="twitter:description" content="代码简单点，bug少一点！">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/7/"/>





  <title> 童真的烂漫 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">童真的烂漫</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/09/28/NSRunLoop/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="童真的烂漫">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="童真的烂漫">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="童真的烂漫" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/09/28/NSRunLoop/" itemprop="url">
                  NSRunLoop
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-09-28T22:33:52+08:00">
                2015-09-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/提高/" itemprop="url" rel="index">
                    <span itemprop="name">提高</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/09/28/NSRunLoop/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/09/28/NSRunLoop/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2015/09/28/NSRunLoop/" class="leancloud_visitors" data-flag-title="NSRunLoop">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="什么是Runloop"><a href="#什么是Runloop" class="headerlink" title="什么是Runloop"></a>什么是Runloop</h2><blockquote>
<p>简单点说就是一个do while的运行循环。主要的作用就是保持程序的持续运行。比如主线程的runloop从程序打开就一直在运行。一个线程对应着一个runloop。RunLoop在第一次获取时创建，在线程结束时销毁。</p>
</blockquote>
<h3 id="NSRunLoop-和-CFRunLoopRef"><a href="#NSRunLoop-和-CFRunLoopRef" class="headerlink" title="NSRunLoop 和 CFRunLoopRef"></a>NSRunLoop 和 CFRunLoopRef</h3><h4 id="1-CFRunLoopRef"><a href="#1-CFRunLoopRef" class="headerlink" title="1 CFRunLoopRef"></a>1 CFRunLoopRef</h4><blockquote>
<p>是在 CoreFoundation 框架内的，它提供了纯 C 函数的 API，所有这些 API 都是线程安全的。</p>
</blockquote>
<h4 id="2-NSRunLoop"><a href="#2-NSRunLoop" class="headerlink" title="2 NSRunLoop"></a>2 NSRunLoop</h4><blockquote>
<p>是基于 CFRunLoopRef 的封装，提供了面向对象的 API，但是这些 API 不是线程安全的。</p>
</blockquote>
<h4 id="3-RunLoop构成"><a href="#3-RunLoop构成" class="headerlink" title="3.RunLoop构成"></a>3.RunLoop构成</h4><p> <img src="http://img.blog.csdn.net/20170220134138089?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMDgyODcxOA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p> 一个 RunLoop 包含若干个Mode，每个Mode又包含若干个Source/Timer/Observer。</p>
<blockquote>
<ul>
<li>RunLoop = n * Mode</li>
<li>Mode = n * (mode item)</li>
<li>mode item = (Source/Timer/Observer)</li>
</ul>
</blockquote>
<p>注意：</p>
<pre><code>1.每次调用 RunLoop 的主函数时，只能指定其中一个 Mode，这个Mode被称作 CurrentMode。如果需要切换 Mode，只能退出 Loop，再重新指定一个 Mode 进入。这样做主要是为了分隔开不同组的 Source/Timer/Observer，让其互不影响。
2.一个 item 可以被同时加入多个 mode。但一个 item 被重复加入同一个 mode 时是不会有效果的。如果一个 mode 中一个 item 都没有，则 RunLoop 会直接退出，不进入循环。
</code></pre><h5 id="3-1CFRunLoopSource-和-CFRunLoopSourceRef"><a href="#3-1CFRunLoopSource-和-CFRunLoopSourceRef" class="headerlink" title="3.1CFRunLoopSource 和 CFRunLoopSourceRef"></a>3.1CFRunLoopSource 和 CFRunLoopSourceRef</h5><h6 id="CFRunLoopSource"><a href="#CFRunLoopSource" class="headerlink" title="CFRunLoopSource"></a>CFRunLoopSource</h6><pre><code>Source是RunLoop的数据源抽象类,类似IOS中的protocol。
RunLoop定义两个Version的Source 
Source0:处理App内部事件,App自己负责管理(触发),如UIEvent,CFSocket 
Source1:由RunLoop和内核管理,Mach port驱动 如CFMach、CFMessage
</code></pre><h6 id="CFRunLoopSourceRef"><a href="#CFRunLoopSourceRef" class="headerlink" title="CFRunLoopSourceRef"></a>CFRunLoopSourceRef</h6><ul>
<li>CFRunLoopSourceRef是事件产生的地方。Source有两个版本：Source0 和 Source1。</li>
<li>Source0 只包含了一个回调（函数指针），它并不能主动触发事件。使用时，你需要先调用CFRunLoopSourceSignal(source)，将这个 Source 标记为待处理，然后手动调用CFRunLoopWakeUp(runloop) 来唤醒 RunLoop，让其处理这个事件。</li>
<li>Source1 包含了一个 mach_port 和一个回调（函数指针），被用于通过内核和其他线程相互发送消息。这种 Source 能主动唤醒 RunLoop 的线程，其原理在下面会讲到。</li>
</ul>
<h4 id="4-构成"><a href="#4-构成" class="headerlink" title="4 构成"></a>4 构成</h4><table>
<thead>
<tr>
<th style="text-align:center">Mode</th>
<th style="text-align:center">Name</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Default</td>
<td style="text-align:center">NSDefaultRunLoopMode (Cocoa) kCFRunLoopDefaultMode (Core Foundation)</td>
<td style="text-align:left">默认mode，大多数用这种mode启动run loop 和配置input sources</td>
</tr>
</tbody>
</table>
<p>1.子线程默认不开启 runloop，如果需要在子线程中异步执行操作，可以利用 runloop 进行线程保活。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">+ (void)networkRequestThreadEntryPoint:(id)__unused object &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        [[NSThread currentThread] setName:@&quot;AFNetworking&quot;];</div><div class="line">        NSRunLoop *runLoop = [NSRunLoop currentRunLoop];</div><div class="line">        [runLoop addPort:[NSMachPort port] forMode:NSDefaultRunLoopMode];</div><div class="line">        [runLoop run];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>2 <a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html#//apple_ref/doc/uid/10000057i-CH16-SW1" target="_blank" rel="external">Runloop</a> 启动方式与方法</p>
<table>
<thead>
<tr>
<th style="text-align:center">启动方式</th>
<th style="text-align:center">启动方法</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Unconditionally</td>
<td style="text-align:center">run</td>
<td style="text-align:left">无条件进入是最简单的做法，但也最不推荐。这会使线程进入死循环，从而不利于控制 runloop，结束 runloop 的唯一方式是 kill 它，它的<strong>本质</strong>就是无限调用 runMode:beforeDate: 方法</td>
</tr>
<tr>
<td style="text-align:center">With a set time limit</td>
<td style="text-align:center">runUntilDate</td>
<td style="text-align:left">如果我们设置了超时时间，那么 runloop 会在处理完事件或超时后结束，此时我们可以选择重新开启 runloop。这种方式要优于前一种，也是重复调用 runMode:beforeDate:，区别在于它超时后就不会再调用</td>
</tr>
<tr>
<td style="text-align:center">In a particular mode</td>
<td style="text-align:center">runMode:beforeDate:</td>
<td style="text-align:left">这是相对来说最优秀的方式，相比于第二种启动方式，我们可以指定 runloop 以哪种模式运行，是 runloop 的单次调用。</td>
</tr>
</tbody>
</table>
<p>31楼：<br>作者的测试方式有问题，Run方法不是不能退出，但要求是隐式的，文档中并没有说明，Run退出的条件是当前RunLoop的所有Items为空时，也就是说当前没有源需要RunLoop处理时，Run方法就会退出。你可以试一下用Run方法启动，再向你添加到RunLoop的那个端口发消息，在回调函数里面把端口源去掉就可以直接退出了。这个测试不能用perform来完成，因为这会使你的目标RunLoop额外被添加一个Source来处理事件，所以，即使你去掉端口源，RunLoop依架不会终止。关于RunLoop，建议看源码和自己做测试，文档在这一部份的勘误实在太多</p>
<p><a href="http://blog.csdn.net/ouyangtianhan/article/details/22039975" target="_blank" rel="external">iOS:.NSRunLoop再理解</a></p>
<p>我们会经常看到这样的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">- (IBAction)start:(id)sender</div><div class="line">&#123;</div><div class="line">	pageStillLoading = YES;</div><div class="line">	[NSThread detachNewThreadSelector:@selector(loadPageInBackground:)toTarget:self         	withObject:nil];</div><div class="line">	[progress setHidden:NO];</div><div class="line">//等loadPageInBackground里面的操作都完成了以后才让[progress setHidden:YES]</div><div class="line">	while (pageStillLoading) &#123;</div><div class="line">		[NSRunLoop currentRunLoop] runMode:NSDefaultRunLoopMode beforeDate:[NSDate distantFuture]];</div><div class="line">	&#125;</div><div class="line">	[progress setHidden:YES];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码很神奇的，因为他会“暂停”代码运行，而且程序运行不会因为这里有一个while循环而受到影响。在[progress setHidden:NO]执行之后，整个函数想暂停了一样停在循环里面，等loadPageInBackground里面的操作都完成了以后才让[progress setHidden:YES]运行。这样做就显得简介，而且逻辑很清晰。如果你不这样做，你就需要在loadPageInBackground里面表示load完成的地方调用[progress setHidden:YES]，显得代码不紧凑而且容易出错。</p>
<h4 id="1-NSRunLoop是消息机制的处理模式"><a href="#1-NSRunLoop是消息机制的处理模式" class="headerlink" title="1.NSRunLoop是消息机制的处理模式"></a>1.NSRunLoop是消息机制的处理模式</h4><blockquote>
<p> NSRunLoop的作用在于有事情做的时候使的当前NSRunLoop的线程工作，没有事情做让当前NSRunLoop的线程休眠</p>
</blockquote>
<h4 id="2-NSRunLoop是循环检测"><a href="#2-NSRunLoop是循环检测" class="headerlink" title="2.NSRunLoop是循环检测"></a>2.NSRunLoop是循环检测</h4><blockquote>
<p> 从线程start到线程end，检测inputsource(如点击，双击等操作)同步事件，检测timesource同步事件，检测到输入源会执行处理函数，首先会产生通知，corefunction向线程添加runloop observers来监听事件，意在监听事件发生时来做处理。</p>
</blockquote>
<h4 id="3-RunLoopMode是一个集合"><a href="#3-RunLoopMode是一个集合" class="headerlink" title="3.RunLoopMode是一个集合"></a>3.RunLoopMode是一个集合</h4><blockquote>
<p>包括监听事件源、定时器、以及需通知的runloop observers</p>
</blockquote>
<ul>
<li>模式包括：</li>
<li>default模式：几乎包括所有输入源(除NSConnection) NSDefaultRunLoopMode模式</li>
<li>mode模式：处理modal panels</li>
<li>connection模式：处理NSConnection事件，属于系统内部，用户基本不用</li>
<li>event tracking模式：如组件拖动输入源 UITrackingRunLoopModes 不处理定时事件</li>
<li><p>common modes模式：NSRunLoopCommonModes 这是一组可配置的通用模式。将input sources与该模式关联则同时也将input sources与该组中的其它模式进行了关联。</p>
</li>
<li><p>模式的作用</p>
</li>
<li>每次运行一个RunLoop，你需要指定（显式或隐式）RunLoop的运行模式</li>
<li>当相应的模式传递给RunLoop时</li>
<li>只有与该模式对应的input sources才被监控并允许RunLoop对事件进行处理</li>
<li><p>只有与该模式对应的observers才会被通知</p>
</li>
<li><p>设置runloop模式</p>
</li>
<li><p>暂停当前处理的流程，转而处理其他输入源，</p>
</li>
<li>当date设置为<a href="将来，基本不会到达的时间">NSDate distantFuture</a>，除非处理其他输入源结束，否则永不退出处理暂停的当前处理的流程。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">//指定runloop模式来处理输入源，首个输入源或date结束退出</div><div class="line">-(BOOL)runMode:(NSString *)mode beforeDate:(NSDate *)date</div><div class="line"></div><div class="line">//当前A为YES时，当前runloop会一直接收处理其他输入源，当前流程不继续处理，出为A为NO，当前流程继续</div><div class="line">	while(A)&#123;</div><div class="line"></div><div class="line">	[[NSRunLoop currentRunLoop] runMode:NSDefaultRunLoopMode beforeDate:[NSDate distantFuture]];</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>​<br>​</p>
<h4 id="4-perform-selector"><a href="#4-perform-selector" class="headerlink" title="4 perform selector"></a>4 perform selector</h4><p>​</p>
<ul>
<li><p>在当前线程的Run Loop下执行指定的 @selector 方法</p>
<p>​<br>​- 当调用 NSObject的performSelector:onThread:时，实际上其内部会创建一个 Timer 并添加到当前线程的 RunLoop 中<br>​- 如果当前线程没有RunLoop的话，performSelector:onThread的方法也就失效<br>​- 线程在执行后会退出当前的RunLoop，也就是RunLoop会在一个线程结束时一同销毁<br>​- performSelector需要注意cancel<br>​</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line">- (void)viewDidLoad &#123;</div><div class="line">    </div><div class="line">    [super viewDidLoad];</div><div class="line"></div><div class="line">     _isNewThreadAborted = NO;</div><div class="line"></div><div class="line">    NSThread *thread = [[NSThread alloc] initWithTarget:self selector:@selector(nslogHi) object:nil];</div><div class="line"></div><div class="line">    [thread setName:@&quot;my control thread&quot;];</div><div class="line"></div><div class="line">    [thread start];</div><div class="line"></div><div class="line">    [NSObject cancelPreviousPerformRequestsWithTarget:self selector:@selector(nslogHello:) object:nil]</div><div class="line"></div><div class="line">    [self performSelector:@selector(nslogHello) onThread:thread withObject:nil waitUntilDone:NO];</div><div class="line"></div><div class="line">    NSLog(@&quot;_end&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">                        </div><div class="line"></div><div class="line"> - (void)nslogHi &#123;</div><div class="line">    </div><div class="line">      //1 线程一直运行或者暂时阻塞一下线程，才会执行hello</div><div class="line">    </div><div class="line">      //向创建的RunLoop添加NSPort（Sources），让Mode不为空，RunLoop能进入循环不会退出。run启动线程，是不会退出</div><div class="line">    </div><div class="line">      //方法1</div><div class="line">    </div><div class="line">      [[NSRunLoop currentRunLoop] addPort:[NSPort port] forMode:NSDefaultRunLoopMode];</div><div class="line"></div><div class="line">      [[NSRunLoop currentRunLoop] run];</div><div class="line">    </div><div class="line">      //方法2</div><div class="line">    </div><div class="line">       while (!_isNewThreadAborted)&#123;</div><div class="line">    </div><div class="line">        [[NSRunLoop currentRunLoop] runUntilDate:[NSDate dateWithTimeIntervalSinceNow:2]];</div><div class="line">    </div><div class="line">        NSLog(@&quot;exiting runloop.........:&quot;);</div><div class="line">    </div><div class="line">        &#125;</div><div class="line">    </div><div class="line">       //方法3 让RunLoop一直尝试运行，判断Mode是否为空，不是为空就进入RunLoop循环</div><div class="line">    </div><div class="line">       while (!_isNewThreadAborted) &#123;</div><div class="line">    </div><div class="line">    </div><div class="line">            BOOL ret = [[NSRunLoop currentRunLoop] runMode:NSDefaultRunLoopMode</div><div class="line">                                                   beforeDate:[NSDate distantFuture]];</div><div class="line">    </div><div class="line">            NSLog(@&quot;exiting runloop.........: %d&quot;, ret);</div><div class="line">    </div><div class="line">        &#125;</div><div class="line">    </div><div class="line">    //如果不加上边的代码</div><div class="line">    </div><div class="line">       NSLog(@&quot;hi....&quot;);</div><div class="line">    </div><div class="line">                                  </div><div class="line">&#125;</div><div class="line">- (void)nslogHello &#123;</div><div class="line"></div><div class="line">      NSLog(@&quot;hello.....&quot;);</div><div class="line"></div><div class="line">      _isNewThreadAborted = YES;</div><div class="line">&#125;</div><div class="line">最会输出：</div><div class="line">       2015-09-28 14:09:15.650 PCRunLoopThread[74414:5556013] hi....</div><div class="line">       2015-09-28 14:09:15.650 PCRunLoopThread[74414:5555961] _end</div></pre></td></tr></table></figure>
<h4 id="5-手动启动runloop的方式"><a href="#5-手动启动runloop的方式" class="headerlink" title="5 手动启动runloop的方式"></a>5 手动启动runloop的方式</h4><pre><code>让一个子线程不进入消亡状态，等待其他线程发来消息，处理其他事件,其实就是让线程跑一个runLoop
</code></pre><ul>
<li><code>-(void)run</code> <ul>
<li>运行 NSRunLoop，运行模式为默认的NSDefaultRunLoopMode模式，没有超时限制。因为无条件运行不建议使用，因为这个接口会导致Run Loop永久性的运行在NSDefaultRunLoopMode模式，即使使用CFRunLoopStop(runloopRef);也无法停止Run Loop的运行，那么这个子线程就无法停止，只能永久运行下去。</li>
<li><code>[[NSRunLoop currentRunLoop] runUntilDate:[NSDate dateWithTimeIntervalSinceNow:10]]</code></li>
<li>运行 NSRunLoop: 参数为运时间期限，运行模式为默认的NSDefaultRunLoopMode模式，自己设置的Run Loop运行时间，超时就退出</li>
</ul>
</li>
<li><code>-(BOOL)runMode:(NSString *)mode beforeDate:(NSDate *)limitDate</code><ul>
<li>mode：      指定runloop模式来处理输入源</li>
<li>limitDate:    设置为NSDate distantFuture，除非处理其他输入源结束，否则永不退出处理暂停的当前处理的流程</li>
<li>return:         NO表示是超时或者停止运行导致返回的，YES表示是处理事件后返回的</li>
<li>非Timer事件触发（比如PerfromSelector事件或者其他Input Source事件），Run Loop会退出返回YES</li>
<li>到达limitDate后会退出返回</li>
<li>显式的用CFRunLoopStop停止Run Loop</li>
</ul>
</li>
</ul>
<h4 id="6-Run-Loop和线程的关系："><a href="#6-Run-Loop和线程的关系：" class="headerlink" title="6 Run Loop和线程的关系："></a>6 Run Loop和线程的关系：</h4><ul>
<li>每条线程都有唯一的一个与之对应的RunLoop对象 </li>
<li>一个线程可以开启多个RunLoop，只不过都是嵌套在最大的RunLoop中，其关系是保存在一个全局的 Dictionary 里</li>
<li>主线程的<code>RunLoop</code>默认是启动的，用于接收各种输入Sources</li>
<li>全局获取其<code>RunLoop</code><ul>
<li><code>[NSRunLoop mainRunLoop]</code>或者 <code>CFRunLoopGetMain()</code></li>
</ul>
</li>
<li>app结束时,销毁</li>
<li>子线程的<code>RunLoop</code>默认是没有启动的，如果你需要更多的线程交互则可以手动配置和启动，如果线程执行一个长时间已确定的任务则不需要<ul>
<li>只能在线程的内部获取其<code>RunLoop</code></li>
<li><code>[NSRunLoop currentRunLoop]</code>或者<code>CFRunLoopGetCurrent()</code>，如果有就获取，没有就创建</li>
<li>子线程结束时，销毁</li>
</ul>
</li>
<li>Run Loop什么情况下使用：<ul>
<li>a. 使用ports 或 input sources 和其他线程通信   // 不了解</li>
<li>b. 在线程中使用timers                                        // 如果不启动run loop，timer的事件是不会响应的</li>
<li>c. 在Cocoa 应用中使用performSelector…方法   // 应该是performSelector…这种方法会启动一个线程并启动run loop吧</li>
<li>让线程执行一个周期性的任务                            // 如果不启动run loop， 线程跑完就可能被系统释放了</li>
</ul>
</li>
</ul>
<p>如下是一个CFRunLoop的demo 帮助理解其使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">-(void)click:(id)sender&#123;</div><div class="line">    NSThread *thread = [[NSThread alloc] initWithTarget:self selector:@selector(playerThread: ) object:nil];</div><div class="line"></div><div class="line">    //开启线程，如果是利用NSOperation，只需要加入到NSOperationQueue里面去就好了，queue自己会在合适的时机执行线程，而不需要程序员自己去控制。</div><div class="line"></div><div class="line">     [thread start];</div><div class="line">&#125;</div><div class="line"></div><div class="line">//!!!如果没有如下的currentLoop 那么不会执行initPlayer方法中的timer 即执行完playerThread便结束</div><div class="line"></div><div class="line"> - (void) playerThread:(id)unused</div><div class="line">&#123;</div><div class="line">    </div><div class="line">    currentLoop = CFRunLoopGetCurrent();//子线程的runloop引用</div><div class="line">    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];//为子线程创建自动释放池</div><div class="line">    [self initPlayer];</div><div class="line">    CFRunLoopRun();</div><div class="line">    [pool release];</div><div class="line">&#125;</div><div class="line">-(void) initPlayer</div><div class="line">&#123;</div><div class="line">// 在这里你可以初始化一个工作类，比如声音或者视频播放</div><div class="line">//注：timer的创建和释放必须在同一线程中。</div><div class="line">//[[NSRunLoop currentRunLoop] addTimer:timer forMode:NSRunLoopCommonModes];  此方法会retain timer对象的引用计数。</div><div class="line"></div><div class="line">   [NSTimer scheduledTimerWithTimeInterval:3.0</div><div class="line">                                    target:self</div><div class="line">                                  selector:@selector(checkState:)</div><div class="line">                                  userInfo:nil</div><div class="line">                                   repeats:YES];</div><div class="line"> &#125;</div><div class="line">-(void) checkState:(NSTimer*) timer</div><div class="line">&#123;</div><div class="line">//需要退出自定义的线程了</div><div class="line">    if()&#123;</div><div class="line">    </div><div class="line">       //释放子线程里面的资源</div><div class="line">    </div><div class="line">      //释放资源的代码....</div><div class="line">    </div><div class="line">     /*结束子线程任务 CFRunLoopStop,This function forces rl to stop running and return control to the function that called CFRunLoopRun or CFRunLoopRunInMode for the current run loop activation. If the run loop is nested with a callout from one activation starting another activation running, only the innermost activation is exited.*/</div><div class="line">    </div><div class="line">    //CFRunLoopStop(currentLoop);</div><div class="line">    </div><div class="line">    &#125;</div><div class="line">   </div><div class="line">          for(int i = 0 ; i &lt; 100; i++)</div><div class="line"></div><div class="line">          &#123;</div><div class="line"></div><div class="line">             NSLog(@&quot;%d&quot;, i);</div><div class="line">          &#125;</div><div class="line">     //CFRunLoopStop 会将当前timer结束掉 如果runloop不结束 timer会反复执行</div><div class="line">    </div><div class="line">          CFRunLoopStop(currentLoop);</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="3-1-例子"><a href="#3-1-例子" class="headerlink" title="3.1 例子"></a>3.1 例子</h5><ol>
<li>在timer与table同时执行情况，当拖动table时，runloop进入UITrackingRunLoopModes模式下，不会处理定时事件，此时timer不能处理，所以此时将timer加入到NSRunLoopCommonModes模式(addTimer forMode)</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">//1 此方法默认添加到当前NSRunLoop中</div><div class="line"></div><div class="line">[NSTimer schduledTimerWithTimeInterval: target:selector:userInfo:repeats];</div><div class="line"></div><div class="line">//2 手动制定添加到自己新建的NSRunLoop的中。注意 timer的释放</div><div class="line"></div><div class="line"> NSTimer *timer = [NSTimer timerWithTimeInterval: invocation:repeates:];</div><div class="line"></div><div class="line"> NSTimer *timer = [[NSTimer alloc] initWithFireDate:...];</div><div class="line"></div><div class="line">[[NSRunLoop currentRunLoop] addTimer:timer forMode:NSRunLoopCommonModes];</div></pre></td></tr></table></figure>
<ol>
<li>在scroll一个页面时来松开，此时connection不会收到消息，由于scroll时runloop为UITrackingRunLoopModes模式，不接收输入源，此时要修改connection的mode</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">NSURLRequest *request = ...</div><div class="line"></div><div class="line">NSURLConnection *connection = [[NSURLConnection alloc]initWithRequest:request delegate:self  startImmediately:NO];</div><div class="line"></div><div class="line">[connection scheduleInRunLoop:[NSRunLoop currentRunLoop]  forMode:NSRunLoopCommonModes];</div><div class="line"></div><div class="line">[connection start];</div></pre></td></tr></table></figure>
<ol>
<li>在你open stream之前，给流对象发送一个scheduleInRunLoop:forMode: 消息，来将该对象配置到一个run loop接收stream events。这样，当流中没有数据可读时可以避免delegate阻塞。如果流是发生在另一个线程，你需要确认该流对象是配置在那个线程的run loop中。你不应该尝试从一个除了包含该流对象的run loop的线程的其他线程中对流进行操作。最后，对NSInputStream对象发送open消息开始对输入数据的流操作。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">//你创建对象之后你应该设置其delegate。当把NSInputStream对象配置到一个run loop，并且有与流相关的事件(例如流中有可读数据)发生时，该对象会收到stream:handleEvent:消息</div><div class="line"></div><div class="line">- (void)setUpStreamForFile:(NSString *)path &#123;</div><div class="line"></div><div class="line">   // iStream is NSInputStream instance variable</div><div class="line"></div><div class="line">   iStream = [[NSInputStream alloc] initWithFileAtPath:path];</div><div class="line"></div><div class="line">   [iStream setDelegate:self];</div><div class="line"></div><div class="line">   [iStream scheduleInRunLoop:[NSRunLoop currentRunLoop]</div><div class="line">                                        forMode:NSDefaultRunLoopMode];</div><div class="line">                                        [iStream open];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">线程实现的几种方式：</div><div class="line"> Operation Objects               // NSOperation及相关子类</div><div class="line">  // dispatch_async等相关函数</div><div class="line"> Idle-time notifications    //  NSNotificationQueue,低优先级</div><div class="line">Asynchronous functions    // 异步函数</div><div class="line">Timers                    // NSTimer</div><div class="line"> Separate processes  // 没用过</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>线程创建的成本</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>kernel data structures</td>
<td>约1KB</td>
</tr>
<tr>
<td>Stack space</td>
<td>512KB(secondary threads)</td>
</tr>
<tr>
<td></td>
<td>1MB(iOS main thread)</td>
</tr>
<tr>
<td>Creation time</td>
<td>约90 microseconds</td>
</tr>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>​​                                        </p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/6/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="童真的烂漫" />
          <p class="site-author-name" itemprop="name">童真的烂漫</p>
          <p class="site-description motion-element" itemprop="description">代码简单点，bug少一点！</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">31</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">16</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">童真的烂漫</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"ilovefeng"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  













  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("mcWzUpQ3AldFJ4kzarMYUdHm-gzGzoHsz", "r4IAP9mahPuKIgHr5NQA4bPF");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  


</body>
</html>
